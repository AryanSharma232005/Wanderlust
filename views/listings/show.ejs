<% layout("/layouts/boilerplate.ejs") %>

<!-- Starability CSS (CDN version) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/starability/starability-all.min.css" />

<div class="container mt-5">
    <h3 class="mb-4">Listing Details</h3>

    <div class="row justify-content-center">
        <div class="col-md-8 col-sm-10">
            <div class="card shadow border-0 p-3">
                <img src="<%= listing.image.url %>" 
                     class="card-img-top rounded mb-3" 
                     alt="listing image" 
                     style="height: 350px; object-fit: cover;">

                <div class="card-body">
                    <h5 class="card-title fw-bold"><%= listing.title %></h5>
                    <p class="card-text mb-2"><%= listing.description %></p>
                    <p class="mb-1">&#8377; <%= listing.price.toLocaleString("en-IN") %></p>
                    <p class="mb-1"><%= listing.location %></p>
                    <p class="mb-3"><%= listing.country %></p>

                    <a href="/listings/<%= listing._id %>/edit" class="btn btn-danger me-2">Edit</a>

                    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
                        <button type="submit" class="btn btn-dark">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Form -->
    <div class="row mt-5 justify-content-center">
        <div class="col-md-8 col-sm-10">
            <div class="card shadow-sm border-0 p-4">
                <h4 class="mb-4">Leave a Review</h4>
                <form method="POST" action="/listings/<%= listing._id %>/reviews" novalidate>
                    
                    <!-- Starability Rating Input -->
                    <div class="mb-4">
                        <label class="form-label d-block">Rating</label>
                        <fieldset class="starability-slot">
                            <input type="radio" id="rate5" name="review[rating]" value="5" required />
                            <label for="rate5" title="Amazing">5 stars</label>

                            <input type="radio" id="rate4" name="review[rating]" value="4" />
                            <label for="rate4" title="Very good">4 stars</label>

                            <input type="radio" id="rate3" name="review[rating]" value="3" />
                            <label for="rate3" title="Average">3 stars</label>

                            <input type="radio" id="rate2" name="review[rating]" value="2" />
                            <label for="rate2" title="Not good">2 stars</label>

                            <input type="radio" id="rate1" name="review[rating]" value="1" />
                            <label for="rate1" title="Terrible">1 star</label>
                        </fieldset>
                    </div>

                    <!-- Comment -->
                    <div class="mb-3">
                        <label for="comment" class="form-label">Comment</label>
                        <textarea 
                            name="review[comment]" 
                            id="comment" 
                            class="form-control" 
                            rows="4" 
                            placeholder="Write your thoughts here..." 
                            required></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>

                <!-- Reviews Section -->
                <hr class="my-4">
                <h4 class="mb-3">All Reviews</h4>

                <ul class="list-group">
                    <% if (listing.reviews.length > 0) { %>
                        <% listing.reviews.forEach(review => { %>
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <fieldset class="starability-result" data-rating="<%= review.rating %>">
                                        Rated: <%= review.rating %> stars
                                    </fieldset>
                                    <small class="text-muted"><%= new Date(review.createdAt).toLocaleDateString() %></small>
                                </div>
                                <p class="mb-0 mt-2"><%= review.comment %></p>
                            </li>
                        <% }) %>
                    <% } else { %>
                        <li class="list-group-item text-muted text-center">
                            No reviews yet. Be the first to leave one!
                        </li>
                    <% } %>
                </ul>
            </div>
        </div>
    </div>
</div>
